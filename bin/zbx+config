#!/bin/bash
source zbx-script-header
## Usage:
## >$ zbx+config <zref?> [FLAGS..]
## If <zref> was not given a guess will be made based on PWD. If not possible - exit code 2
## If <zref> was given and not found or invalid - exit code 3
## 
## This program creates config for server (only if installed) and for frontend always.
# TODO limit config to write srv only or php only via flags
bak=$1;case $1 in
.      ) REF=$(echo "$LOCALREFS" | fzf);shift;;
'' | -*) REF=$(zbx-util-guess-ref);        [ -z "$REF" ] && exit 2        ;;
m*     ) REF=master;shift;;
*      ) REF=$(zbx-util-validate-zref $1); [ -z "$REF" ] && exit 3 ; shift;;
esac

[ ! -d $WORKTREE/$REF/frontends/php ] \
    && >&2 printf "Not a project directory '%s'\nTry: zbx,dev %s\n" $WORKTREE/$REF $bak \
    && exit 3
unset bak

frontend=$WORKTREE/$REF/frontends/php/conf/zabbix.conf.php
DREF=$(echo $REF | tr / _)

cat > $frontend <<- EOM
<?php
global \$DB, \$HISTORY;
\$DB['TYPE'] = 'POSTGRESQL';
\$DB['SERVER'] = 'zbx-box-db';
\$DB['PORT'] = '0';
\$DB['DATABASE'] = '${REF}';
\$DB['USER'] = 'postgres';
\$DB['PASSWORD'] = 'example';
\$DB['SCHEMA'] = '';
\$ZBX_SERVER = 'zbx-box-server-${DREF}';
\$ZBX_SERVER_PORT = '10051';
\$ZBX_SERVER_NAME = '${REF}.[POSTGRESQL]';
\$IMAGE_FORMAT_DEFAULT = IMAGE_FORMAT_PNG;
EOM

echo "conf-gen >> $frontend"
echo

if [ -d $WORKTREE/$REF/dist ];then

    srv=$WORKTREE/$REF/dist/etc/zabbix_server.conf
    agent=$WORKTREE/$REF/dist/etc/zabbix_agentd.conf

    echo "Include=/www/$REF/dist/etc/zabbix_server.conf.d/*.conf" >> $srv;
    cat > $srv.d/override.conf <<- EOM
    LogFile=/www/$REF/dist/zabbix_server.log
    DBHost=zbx-box-db
    DBName=$REF
    DBUser=postgres
    DBPassword=example
    LogSlowQueries=200
    Timeout=4
    CacheSize=512M
    TrendCacheSize=64M
    ValueCacheSize=1G
    AlertScriptsPath=/www/$REF/dist/share/zabbix/alertscripts
EOM

echo "conf-gen >> $srv"
echo "conf-gen >> $srv.d/override.conf"
echo

    cat > $agent <<- EOM
    LogFile=/www/$REF/dist/zabbix_agentd.log
    EnableRemoteCommands=1
    LogRemoteCommands=1
    Server=zbx-box-server-$DREF
EOM

echo "conf-gen >> $agent"
echo

fi

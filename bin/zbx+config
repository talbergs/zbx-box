#!/bin/bash
### Usage: $0 <zref?> [FLAG?..]
## Stub all config files based on templates.
## Example:
##         $0
##         # All options are implied - all configs are rewritten.
##         # Workspace is determined by \$PWD.
## Example:
##         $0 ZBX-123-4.0
##         # All options are implied - all configs are rewritten for workspace "feature/ZBX-123-4.0"
## Example:
##         $0 --vim --server
##         # Apply specific configs only.
## Example:
##         $0 . --vim --server
##         # Apply specific configs only (workspace menu will be opened).
## Example:
##         $0 4.0 --vim --server
##         # Apply specific configs only for workspace release/4.0
source zbx-script-header
source zbx-get-ref

DREF=$(zbx-util-ref-to-dref $REF)

frontend(){
    file=$WORKTREE/$REF/frontends/php/conf/zabbix.conf.php
    zbx-util-tmpl $ZBX_BOX_ROOT/tmpl/zabbix.conf.php.tmpl REF=$REF DREF=$DREF > $file
    nl $file | zbx-util-color -H "$file"
}

vim(){
    file=$WORKTREE/$REF/.vimrc
    zbx-util-tmpl $ZBX_BOX_ROOT/tmpl/vimrc.tmpl > $file
    nl $file | zbx-util-color -H "$file"
}

server(){
    file=$WORKTREE/$REF/zabbix_server.conf
    zbx-util-tmpl $ZBX_BOX_ROOT/tmpl/zabbix_server.conf.tmpl REF=$REF DREF=$DREF > $file
    nl $file | zbx-util-color -H "$file"
}

agentd(){
    file=$WORKTREE/$REF/zabbix_agentd.conf
    zbx-util-tmpl $ZBX_BOX_ROOT/tmpl/zabbix_agentd.conf.tmpl REF=$REF DREF=$DREF > $file
    nl $file | zbx-util-color -H "$file"
}

ex=()
if [ $# -eq 0 ]; then
    ex=(agentd server vim frontend)
fi

while [[ $# > 0 ]];do case $1 in
    #- Write vimrc only.
    -V | --vim ) ex+=(vim) ;;
    #- Write agentd config only.
    -A | --agentd ) ex+=(agentd) ;;
    #- Write server config only.
    -S | --server ) ex+=(server) ;;
    #- Write frontend config only.
    -F | --frontend ) ex+=(frontend) ;;
esac;shift;done

for e in ${ex[*]}; do
    $e
done

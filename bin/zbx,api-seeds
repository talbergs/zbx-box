#!/bin/bash
source zbx-script-header
### Usage: $0 <zref?> [FLAGS..]
## Seeds various common data things - all level user accounts, trapper and host.
## uses API calls

bak=$1;case $1 in
.      ) REF=$(echo "$LOCALREFS" | fzf);shift;;
'' | -*) REF=$(zbx-util-guess-ref);        [ -z "$REF" ] && exit 2        ;;
m*     ) REF=master;shift;;
*      ) REF=$(zbx-util-validate-zref $1); [ -z "$REF" ] && exit 3 ; shift;;
esac

TOKEN=
curl_api() {
    METHOD=$1
    PARAMS=$2
    AUTH=

    if [ ! -z $TOKEN ];then
        AUTH=',"auth":"'$TOKEN'"'
    fi

    echo '
    {"params": '$PARAMS',
    "jsonrpc": "2.0", "method": "'$METHOD'", "id": 0'$AUTH'}
    ' | curl --silent -X POST -H 'Content-Type: application/json-rpc' \
    -d @- http://localhost/$REF/frontends/php/api_jsonrpc.php | jq '.result' --raw-output
}

#LOGIN
TOKEN=$(curl_api 'user.login' '{"password": "zabbix", "user": "Admin"}')

# host a
HOST_A_ID=$(curl_api 'host.create' '{
    "host": "a",
    "interfaces": [{
        "type": 1,
        "main": 1,
        "useip": 1,
        "ip": "192.168.3.1",
        "dns": "",
        "port": "10050"
    }],
    "groups": [{"groupid": "5"}]
}' | jq ".hostids[0]" -r)

ITEM_A_ID=$(curl_api 'item.create' '{
    "name": "a",
    "key_": "a",
    "hostid": "'$HOST_A_ID'",
    "type": 2,
    "value_type": 3
}' | jq ".itemids[0]" -r)

curl_api 'trigger.create' '{
    "description": "trig-a",
    "expression": "{a:a.last()}=0",
    "priority": "2"
}'

#LOGOUT
curl_api 'user.logout'

#!/bin/bash
case $1 in
    -h | --help )zbx.-h $0 && exit;;
    -e | --edit )$EDITOR $0;exit;;
    -c | --cat )cat $0;exit;;
esac
## Exports many useful variables that may be used in session (or subshells).
## For performance reasons should not be called directly in scripts,
## only through use of `zbx-script-header` that is usually sourced at top
## of script providing variables and -h flag.
## 
## Also ensures environment, by setting services up and cloning base repo if needed.

export ZBX_BOX_ROOT=$(cd $(dirname $0)/../;pwd)

[ ! -f "$ZBX_BOX_ROOT/.env" ] && >&2 echo "Not found: $ZBX_BOX_ROOT/.env" && exit 4
source $ZBX_BOX_ROOT/.env

mkdir -p $WORKTREE/{master,{feature,release}}

[ ! -d "$WORKTREE/master/.git" ] && git clone $GITREMOTE $WORKTREE/master
[ ! -f "$WORKTREE/master/.git/hooks/deployed" ] \
    && cp -RT "$ZBX_BOX_ROOT/git.hooks" "$WORKTREE/master/.git/hooks"

# TODO bake these things: webgrind, opcache-gui, into dashboard
[ ! -f "$WORKTREE/opcache-gui.php" ] && \
    wget https://raw.githubusercontent.com/amnuts/opcache-gui/master/index.php -O $WORKTREE/opcache-gui.php
[ ! -f "$WORKTREE/phpinfo.php" ] && echo '<?php phpinfo();' > "$WORKTREE/phpinfo.php"

export ZBX_ENV_SOURCED=1

#- URL to reop
export WORKTREE=$WORKTREE
export GITREMOTE=$GITREMOTE
export WEBTLD=$WEBTLD
export JIRAUSER=$JIRAUSER
export JIRAURL=$JIRAURL
export BITBUCKET_PROJECT=$BITBUCKET_PROJECT
export PHP_VERSION=$PHP_VERSION

export PATH=$PATH:$ZBX_BOX_ROOT/bin/util

export REFS=$(git ls-remote --refs --heads $GITREMOTE | sed 's|^.*heads/||g')
export LOCALREFS=$(cd $WORKTREE/master && git worktree list --porcelain | ag '^branch' | sed 's#^.*heads/##')

# echo -n $(cat $WORKTREE/master/frontends/php/include/defines.inc.php \
#     | grep ZABBIX_VERSION \
#     | awk -F\' '{print $4}')

cd $ZBX_BOX_ROOT
docker-compose up -d --remove-orphans &>/dev/null &
cd - &> /dev/null
# docker-compose up -d --remove-orphans $ZBX_BOX_ENABLED_SERVICES

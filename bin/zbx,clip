#!/bin/bash
source zbx-script-header
## Clips common stuff.
case $1 in
. ) REF=$(echo "$LOCALREFS" | fzf);shift;;
m*) REF=master;shift;;
'') REF=$(zbx-util-guess-ref);;
* ) REF=$(zbx-util-validate-zref $1);shift;;
esac

fzclip() {
    local -n clips=$1
    local IFS=$'\n'
    echo "${clips[*]}" | fzf | $SYS_CLIPBOARD
}

CLIPS=("<[~$JIRAUSER]> CLOSED")
CLIPS+=("*(1)* No translation string changes.")

[ -z $REF ] && fzclip CLIPS && exit;

cd $WORKTREE/$REF

# we use first 9 digits of sha
SHA="$(git rev-parse HEAD | head -c 9)"

SHALINK="[$SHA|$BITBUCKET_PROJECT/commits/$SHA]"
REFLINKQ="targetBranch=refs/tags/$(zbx,version)&sourceBranch=refs/heads/$REF"
REFLINK="[$REF|$BITBUCKET_PROJECT/compare/diff?$REFLINKQ]"
VERSION="$(zbx,version)"

CLIPS+=("<[~$JIRAUSER]> CLOSED with minor fix in $SHALINK")
CLIPS+=("<[~$JIRAUSER]> RESOLVED in $SHALINK")
CLIPS+=("<[~$JIRAUSER]> IMPLEMENTED in $SHALINK")
CLIPS+=("IMPLEMENTED in development branch $REFLINK")
CLIPS+=("FIXED in development branch $REFLINK")
CLIPS+=("- *$(zbx,version)* $SHA")

CLIPS+=("git push --delete origin $REF")
CLIPS+=("git cherry-pick -m 1 -x $SHA")
CLIPS+=("git merge origin/$REF --no-ff --no-commit")

fzclip CLIPS
